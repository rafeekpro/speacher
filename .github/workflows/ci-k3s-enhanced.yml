name: CI/CD Pipeline (Enhanced WireGuard Diagnostics)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  K3S_CLUSTER_IP: '10.204.201.1'
  WG_PRIVATE_KEY: ${{ secrets.WG_PRIVATE_KEY }}
  WG_PEER_PUBLIC_KEY: ${{ secrets.WG_PEER_PUBLIC_KEY }}
  WG_ENDPOINT: ${{ secrets.WG_ENDPOINT }}
  # Diagnostics thresholds
  WG_LATENCY_WARNING_MS: 100
  WG_LATENCY_CRITICAL_MS: 500
  WG_HANDSHAKE_TIMEOUT_S: 30

jobs:
  wireguard-diagnostics:
    name: WireGuard Diagnostics
    runs-on: ubuntu-latest
    # Optional job - runs on demand or manual trigger
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Setup WireGuard tunnel
      id: wg_setup
      run: |
        echo "üîê Setting up WireGuard tunnel for diagnostics..."
        START_TIME=$(date +%s)

        # Install WireGuard
        sudo apt-get update -qq
        sudo apt-get install -y wireguard wireguard-tools

        # Create WireGuard configuration
        cat <<EOF | sudo tee /etc/wireguard/wg0.conf
        [Interface]
        PrivateKey = ${{ env.WG_PRIVATE_KEY }}
        Address = 10.0.0.2/32
        DNS = 10.204.201.1

        [Peer]
        PublicKey = ${{ env.WG_PEER_PUBLIC_KEY }}
        Endpoint = ${{ env.WG_ENDPOINT }}
        AllowedIPs = 10.0.0.1/32, 10.204.201.0/24
        PersistentKeepalive = 25
        EOF

        # Start WireGuard interface
        sudo wg-quick up wg0

        # Calculate tunnel establishment time
        END_TIME=$(date +%s)
        SETUP_TIME=$((END_TIME - START_TIME))
        echo "wg_setup_time=${SETUP_TIME}s" >> $GITHUB_OUTPUT

    - name: Run comprehensive diagnostics
      id: wg_diagnostics
      run: |
        echo "üîç Running comprehensive WireGuard diagnostics..."
        echo ""

        # Colors for output
        GREEN='\033[0;32m'
        RED='\033[0;31m'
        YELLOW='\033[1;33m'
        NC='\033[0m'

        # Create diagnostic report
        REPORT_FILE=wg-diagnostic-report.md
        echo "# WireGuard Diagnostics Report" > $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $REPORT_FILE
        echo "**Workflow Run:** ${{ github.run_number }}" >> $REPORT_FILE
        echo "**Commit:** ${{ github.sha }}" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # 1. Configuration Validation
        echo "## 1. Configuration Validation" >> $REPORT_FILE
        echo '```' >> $REPORT_FILE
        sudo wg show wg0 >> $REPORT_FILE 2>&1 || echo "wg show failed" >> $REPORT_FILE
        echo '```' >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # 2. Handshake Verification
        echo "## 2. Handshake Status" >> $REPORT_FILE
        HANDSHAKE_INFO=$(sudo wg show wg0 | grep -oP '(?<=latest handshake: )[^,]+' || echo "")
        if [ -n "$HANDSHAKE_INFO" ]; then
          echo -e "${GREEN}‚úÖ${NC} Latest handshake: $HANDSHAKE_INFO"
          echo "**Status:** ‚úÖ Successful" >> $REPORT_FILE
          echo "**Latest Handshake:** $HANDSHAKE_INFO" >> $REPORT_FILE

          # Calculate handshake age
          HANDSHAKE_TIME=$(date -d "$HANDSHAKE_INFO" +%s 2>/dev/null || echo 0)
          CURRENT_TIME=$(date +%s)
          HANDSHAKE_AGE=$((CURRENT_TIME - HANDSHAKE_TIME))

          if [ $HANDSHAKE_AGE -lt 180 ]; then
            echo -e "${GREEN}‚úÖ${NC} Handshake is recent (${HANDSHAKE_AGE}s ago)"
            echo "**Age:** ${HANDSHAKE_AGE}s (healthy)" >> $REPORT_FILE
          elif [ $HANDSHAKE_AGE -lt 600 ]; then
            echo -e "${YELLOW}‚ö†Ô∏è${NC} Handshake is stale (${HANDSHAKE_AGE}s ago)"
            echo "**Age:** ${HANDSHAKE_AGE}s (stale)" >> $REPORT_FILE
          else
            echo -e "${RED}‚ùå${NC} Handshake is very old (${HANDSHAKE_AGE}s ago)"
            echo "**Age:** ${HANDSHAKE_AGE}s (critical)" >> $REPORT_FILE
          fi
        else
          echo -e "${RED}‚ùå${NC} No handshake detected!"
          echo "**Status:** ‚ùå No handshake" >> $REPORT_FILE
          echo "**Action:** Check peer configuration and endpoint connectivity" >> $REPORT_FILE
        fi
        echo "" >> $REPORT_FILE

        # 3. Transfer Statistics
        echo "## 3. Transfer Statistics" >> $REPORT_FILE
        TRANSFER_INFO=$(sudo wg show wg0 | grep -oP '(?<=transfer: )[^\n]+' || echo "")
        if [ -n "$TRANSFER_INFO" ]; then
          echo -e "${GREEN}üìä${NC} Transfer: $TRANSFER_INFO"
          echo "**Data Transfer:** $TRANSFER_INFO" >> $REPORT_FILE

          # Parse transfer stats
          RX=$(echo $TRANSFER_INFO | grep -oP '[\d.]+(?= MiB received)' || echo "0")
          TX=$(echo $TRANSFER_INFO | grep -oP '[\d.]+(?= MiB sent)' || echo "0")
          TOTAL=$(echo "$RX + $TX" | bc || echo "unknown")
          echo "**Total Volume:** ${TOTAL} MiB" >> $REPORT_FILE
        else
          echo -e "${YELLOW}‚ö†Ô∏è${NC} No transfer data available"
          echo "**Status:** ‚ö†Ô∏è No data transferred yet" >> $REPORT_FILE
        fi
        echo "" >> $REPORT_FILE

        # 4. Latency Measurement
        echo "## 4. Latency Measurement" >> $REPORT_FILE
        LATENCY_MS=$(ping -c 10 -i 0.2 ${{ env.K3S_CLUSTER_IP }} 2>/dev/null | tail -1 | grep -oP '(?<=mdev = )[\d.]+' || echo "")

        if [ -n "$LATENCY_MS" ]; then
          echo "**Latency:** ${LATENCY_MS} ms" >> $REPORT_FILE

          # Convert to integer for comparison
          LATENCY_INT=$(printf "%.0f" $LATENCY_MS)

          if [ $LATENCY_INT -lt ${{ env.WG_LATENCY_WARNING_MS }} ]; then
            echo -e "${GREEN}‚úÖ${NC} Latency: ${LATENCY_MS}ms (excellent)"
            echo "**Status:** ‚úÖ Excellent" >> $REPORT_FILE
          elif [ $LATENCY_INT -lt ${{ env.WG_LATENCY_CRITICAL_MS }} ]; then
            echo -e "${YELLOW}‚ö†Ô∏è${NC} Latency: ${LATENCY_MS}ms (degraded)"
            echo "**Status:** ‚ö†Ô∏è Degraded" >> $REPORT_FILE
            echo "**Recommendation:** Investigate network congestion or routing issues" >> $REPORT_FILE
          else
            echo -e "${RED}‚ùå${NC} Latency: ${LATENCY_MS}ms (critical)"
            echo "**Status:** ‚ùå Critical" >> $REPORT_FILE
            echo "**Action:** Immediate investigation required" >> $REPORT_FILE
          fi
        else
          echo -e "${RED}‚ùå${NC} Latency measurement failed"
          echo "**Status:** ‚ùå Cannot measure latency" >> $REPORT_FILE
        fi
        echo "" >> $REPORT_FILE

        # 5. Connectivity Tests
        echo "## 5. Connectivity Tests" >> $REPORT_FILE

        # Test basic connectivity
        echo "### Basic Connectivity" >> $REPORT_FILE
        if ping -c 3 ${{ env.K3S_CLUSTER_IP }} &>/dev/null; then
          echo -e "${GREEN}‚úÖ${NC} Can ping cluster at ${{ env.K3S_CLUSTER_IP }}"
          echo "**Ping Test:** ‚úÖ Passed" >> $REPORT_FILE
        else
          echo -e "${RED}‚ùå${NC} Cannot ping cluster"
          echo "**Ping Test:** ‚ùå Failed" >> $REPORT_FILE
        fi

        # Test Kubernetes API port
        echo "### Kubernetes API" >> $REPORT_FILE
        if timeout 3 bash -c "echo >/dev/tcp/${{ env.K3S_CLUSTER_IP }}/6443" 2>/dev/null; then
          echo -e "${GREEN}‚úÖ${NC} Kubernetes API (6443) reachable"
          echo "**API Port (6443):** ‚úÖ Reachable" >> $REPORT_FILE
        else
          echo -e "${RED}‚ùå${NC} Kubernetes API not reachable"
          echo "**API Port (6443):** ‚ùå Unreachable" >> $REPORT_FILE
        fi
        echo "" >> $REPORT_FILE

        # 6. Configuration Comparison
        echo "## 6. Configuration Validation" >> $REPORT_FILE

        # Check endpoint
        CONFIG_ENDPOINT=$(grep -oP '(?<=Endpoint = )[^\s]+' /etc/wireguard/wg0.conf)
        echo "**Configured Endpoint:** $CONFIG_ENDPOINT" >> $REPORT_FILE

        # Check allowed IPs
        CONFIG_ALLOWED_IPS=$(grep -oP '(?<=AllowedIPs = )[^\n]+' /etc/wireguard/wg0.conf)
        echo "**Allowed IPs:** $CONFIG_ALLOWED_IPS" >> $REPORT_FILE

        # Check persistent keepalive
        CONFIG_KEEPALIVE=$(grep -oP '(?<=PersistentKeepalive = )[^\n]+' /etc/wireguard/wg0.conf)
        echo "**Persistent Keepalive:** $CONFIG_KEEPALIVE seconds" >> $REPORT_FILE

        # Validate configuration
        echo "" >> $REPORT_FILE
        echo "### Configuration Validation Results" >> $REPORT_FILE

        if [ -n "$CONFIG_ENDPOINT" ] && [ "$CONFIG_ENDPOINT" = "${{ env.WG_ENDPOINT }}" ]; then
          echo "**Endpoint:** ‚úÖ Matches expected" >> $REPORT_FILE
        else
          echo "**Endpoint:** ‚ùå Mismatch detected" >> $REPORT_FILE
        fi

        if [ -n "$CONFIG_ALLOWED_IPS" ]; then
          echo "**Allowed IPs:** ‚úÖ Configured" >> $REPORT_FILE
        else
          echo "**Allowed IPs:** ‚ùå Missing" >> $REPORT_FILE
        fi

        if [ -n "$CONFIG_KEEPALIVE" ]; then
          echo "**Keepalive:** ‚úÖ Enabled (${CONFIG_KEEPALIVE}s)" >> $REPORT_FILE
        else
          echo "**Keepalive:** ‚ö†Ô∏è Not configured (NAT traversal may fail)" >> $REPORT_FILE
        fi
        echo "" >> $REPORT_FILE

        # 7. Recommendations
        echo "## 7. Recommendations" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Generate recommendations based on diagnostics
        NEEDS_RECOMMENDATIONS=false

        if [ -z "$HANDSHAKE_INFO" ]; then
          echo "- ‚ùå **CRITICAL:** No WireGuard handshake detected" >> $REPORT_FILE
          echo "  - Verify peer public key matches server configuration" >> $REPORT_FILE
          echo "  - Check endpoint connectivity: \`ping ${{ env.WG_ENDPOINT }}\`" >> $REPORT_FILE
          echo "  - Ensure firewall allows UDP port 51820" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          NEEDS_RECOMMENDATIONS=true
        fi

        if [ -n "$LATENCY_MS" ]; then
          LATENCY_INT=$(printf "%.0f" $LATENCY_MS)
          if [ $LATENCY_INT -ge ${{ env.WG_LATENCY_WARNING_MS }} ]; then
            echo "- ‚ö†Ô∏è **WARNING:** Elevated latency (${LATENCY_MS}ms)" >> $REPORT_FILE
            echo "  - Check network congestion between runner and cluster" >> $REPORT_FILE
            echo "  - Consider enabling WireGuard congestion control" >> $REPORT_FILE
            echo "  - Monitor packet loss with: \`ping -c 100 ${{ env.K3S_CLUSTER_IP }}\`" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            NEEDS_RECOMMENDATIONS=true
          fi
        fi

        if [ "$NEEDS_RECOMMENDATIONS" = false ]; then
          echo "- ‚úÖ **All systems operational** - No action required" >> $REPORT_FILE
        fi

        # Store report path
        echo "diagnostic_report=${REPORT_FILE}" >> $GITHUB_OUTPUT

        # Upload full diagnostic report
        echo ""
        echo "================================"
        echo "üìä Diagnostic Report Summary"
        echo "================================"
        cat $REPORT_FILE

    - name: Upload diagnostic report
      uses: actions/upload-artifact@v4
      with:
        name: wireguard-diagnostics-${{ github.run_id }}
        path: wg-diagnostic-report.md
        retention-days: 30

    - name: Comment PR with diagnostic results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('wg-diagnostic-report.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üîç WireGuard Diagnostics\n\n${report}`
          });

    - name: Teardown WireGuard
      if: always()
      run: |
        echo "üîê Tearing down WireGuard tunnel..."
        sudo wg-quick down wg0 || true
        echo "‚úÖ WireGuard tunnel stopped"

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup WireGuard tunnel to K3s cluster
      id: wg_setup
      run: |
        echo "üîê Setting up WireGuard tunnel to K3s cluster at ${{ env.K3S_CLUSTER_IP }}..."
        START_TIME=$(date +%s)

        # Install WireGuard
        sudo apt-get update -qq
        sudo apt-get install -y wireguard

        # Create WireGuard configuration
        cat <<EOF | sudo tee /etc/wireguard/wg0.conf
        [Interface]
        PrivateKey = ${{ env.WG_PRIVATE_KEY }}
        Address = 10.0.0.2/32
        DNS = 10.204.201.1

        [Peer]
        PublicKey = ${{ env.WG_PEER_PUBLIC_KEY }}
        Endpoint = ${{ env.WG_ENDPOINT }}
        AllowedIPs = 10.0.0.1/32, 10.204.201.0/24
        PersistentKeepalive = 25
        EOF

        # Start WireGuard interface
        sudo wg-quick up wg0

        # Test connection to K3s cluster
        ping -c 3 ${{ env.K3S_CLUSTER_IP }} || {
          echo "‚ùå Cannot reach K3s cluster through WireGuard"
          sudo wg-quick down wg0
          exit 1
        }

        END_TIME=$(date +%s)
        SETUP_TIME=$((END_TIME - START_TIME))
        echo "‚úÖ WireGuard tunnel established in ${SETUP_TIME}s"
        sudo wg show

        # Store setup time for monitoring
        echo "wg_setup_time=${SETUP_TIME}s" >> $GITHUB_OUTPUT

    - name: WireGuard health check
      id: wg_health
      run: |
        echo "üîç Performing WireGuard health check..."

        # Verify handshake
        HANDSHAKE=$(sudo wg show wg0 | grep -oP '(?<=latest handshake: )[^,]+')
        if [ -n "$HANDSHAKE" ]; then
          echo "‚úÖ Handshake: $HANDSHAKE"

          # Calculate handshake age
          HANDSHAKE_TIME=$(date -d "$HANDSHAKE" +%s 2>/dev/null || echo 0)
          CURRENT_TIME=$(date +%s)
          HANDSHAKE_AGE=$((CURRENT_TIME - HANDSHAKE_TIME))

          if [ $HANDSHAKE_AGE -lt 180 ]; then
            echo "‚úÖ Handshake is recent (${HANDSHAKE_AGE}s ago)"
            echo "wg_health=healthy" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Handshake is stale (${HANDSHAKE_AGE}s ago)"
            echo "wg_health=stale" >> $GITHUB_OUTPUT
          fi
        else
          echo "‚ùå No handshake detected!"
          echo "wg_health=failed" >> $GITHUB_OUTPUT
        fi

        # Measure latency
        LATENCY=$(ping -c 5 -i 0.5 ${{ env.K3S_CLUSTER_IP }} | tail -1 | grep -oP '(?<=mdev = )[\d.]+' || echo "")
        if [ -n "$LATENCY" ]; then
          echo "‚úÖ Latency: ${LATENCY}ms"
          echo "wg_latency=${LATENCY}ms" >> $GITHUB_OUTPUT

          LATENCY_INT=$(printf "%.0f" $LATENCY)
          if [ $LATENCY_INT -ge ${{ env.WG_LATENCY_WARNING_MS }} ]; then
            echo "‚ö†Ô∏è Warning: Latency exceeds threshold (${{ env.WG_LATENCY_WARNING_MS }}ms)"
            echo "wg_latency_status=degraded" >> $GITHUB_OUTPUT
          else
            echo "wg_latency_status=good" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Configure kubectl for K3s cluster
      run: |
        echo "‚öôÔ∏è Configuring kubectl for remote K3s cluster..."

        # Create kubeconfig for remote K3s cluster
        mkdir -p $HOME/.kube

        # Use kubeconfig from secret
        echo "${{ secrets.K3S_KUBECONFIG }}" | base64 -d > $HOME/.kube/config

        # Replace localhost with cluster IP
        sed -i 's/127.0.0.1/${{ env.K3S_CLUSTER_IP }}/g' $HOME/.kube/config
        chmod 600 $HOME/.kube/config

        echo "‚úÖ kubectl configured"
        kubectl cluster-info

    - name: Deploy MongoDB for tests
      run: |
        echo "üóÑÔ∏è Deploying ephemeral MongoDB pod in K3s..."

        # Create unique namespace for this test run
        TEST_NAMESPACE="ci-${{ github.run_id }}"
        kubectl create namespace $TEST_NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

        # Deploy MongoDB pod
        kubectl run mongodb-${{ github.run_id }} \
          --image=mongo:6.0 \
          --port=27017 \
          --namespace=$TEST_NAMESPACE \
          --restart=Never \
          --env="MONGO_INITDB_ROOT_USERNAME=admin" \
          --env="MONGO_INITDB_ROOT_PASSWORD=testpass" \
          --labels="test-run=${{ github.run_id }}"

        # Expose MongoDB service
        kubectl expose pod mongodb-${{ github.run_id }} \
          --port=27017 \
          --namespace=$TEST_NAMESPACE \
          --name=mongodb-svc-${{ github.run_id }}

        # Wait for MongoDB to be ready
        kubectl wait --for=condition=ready pod/mongodb-${{ github.run_id }} \
          --namespace=$TEST_NAMESPACE \
          --timeout=120s

        echo "‚úÖ MongoDB deployed in namespace: $TEST_NAMESPACE"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/base.txt
        pip install -r requirements/test.txt

    - name: Run unit tests
      env:
        MONGODB_URI: mongodb://admin:testpass@mongodb-svc-${{ github.run_id }}.ci-${{ github.run_id }}.svc.cluster.local:27017
        S3_BUCKET_NAME: test-bucket
        AZURE_STORAGE_ACCOUNT: test-account
        GCP_PROJECT_ID: test-project
      run: |
        pytest tests/test_api.py -v --cov=src/backend --cov-report=xml

    - name: Run integration tests
      env:
        MONGODB_URI: mongodb://admin:testpass@mongodb-svc-${{ github.run_id }}.ci-${{ github.run_id }}.svc.cluster.local:27017
      run: |
        pytest tests/test_integration.py -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Debug WireGuard on test failure
      if: failure()
      run: |
        echo "üêû Tests failed - Gathering WireGuard diagnostics..."
        echo ""

        echo "=== WireGuard Status ==="
        sudo wg show wg0

        echo ""
        echo "=== Recent Handshakes ==="
        sudo wg show wg0 | grep handshake || echo "No handshake data"

        echo ""
        echo "=== Connection Quality ==="
        ping -c 10 ${{ env.K3S_CLUSTER_IP }}

        echo ""
        echo "=== Transfer Statistics ==="
        sudo wg show wg0 | grep transfer

        echo ""
        echo "=== Kubernetes Connectivity ==="
        kubectl get nodes --timeout=10s || echo "Cannot connect to Kubernetes"

    - name: Teardown WireGuard tunnel
      if: always()
      run: |
        echo "üîê Tearing down WireGuard tunnel..."
        sudo wg-quick down wg0 || true
        echo "‚úÖ WireGuard tunnel stopped"

    - name: Cleanup test resources
      if: always()
      run: |
        TEST_NAMESPACE="ci-${{ github.run_id }}"
        echo "üßπ Cleaning up test resources in namespace: $TEST_NAMESPACE..."

        # Re-establish tunnel for cleanup
        sudo wg-quick up wg0 || true

        # Delete test namespace and all resources
        kubectl delete namespace $TEST_NAMESPACE --wait=false --ignore-not-found=true || true

        # Teardown tunnel again
        sudo wg-quick down wg0 || true
        echo "‚úÖ Cleanup completed"

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy

    - name: Run Black
      run: black --check src/ tests/
      continue-on-error: true

    - name: Run isort
      run: isort --check-only src/ tests/
      continue-on-error: true

    - name: Run Flake8
      run: flake8 src/ tests/ --max-line-length=120 --ignore=E203,W503
      continue-on-error: true

    - name: Run MyPy
      run: |
        # Use mypy with pyproject.toml configuration to avoid module path duplication
        mypy src/backend src/speecher --config-file pyproject.toml
      continue-on-error: true

  container-build:
    name: Build Container Images
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Backend Image
      run: |
        echo "üèóÔ∏è Building backend image with Docker..."
        docker build \
          --file=./Dockerfile \
          --tag=speecher-backend:test \
          --cache-from type=local,src=/tmp/.buildx-cache \
          --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
          .

        # Move cache
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

        echo "‚úÖ Backend image built successfully"
        docker images speecher-backend:test

    - name: Build Frontend Image
      run: |
        if [ -f "docker/react.Dockerfile" ]; then
          echo "üèóÔ∏è Building frontend image with Docker..."
          docker build \
            --file=./docker/react.Dockerfile \
            --tag=speecher-frontend:test \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new-frontend,mode=max \
            .

          # Move cache
          rm -rf /tmp/.buildx-cache-new-frontend || true

          echo "‚úÖ Frontend image built successfully"
          docker images speecher-frontend:test
        else
          echo "‚ÑπÔ∏è Frontend Dockerfile not found, skipping frontend build"
        fi

    - name: Test with Kubernetes (Full Stack Integration)
      id: k8s_test
      run: |
        echo "üß™ Testing built containers with full K3s integration..."

        # Setup WireGuard for K8s access
        sudo apt-get install -y wireguard
        cat <<EOF | sudo tee /etc/wireguard/wg0.conf
        [Interface]
        PrivateKey = ${{ env.WG_PRIVATE_KEY }}
        Address = 10.0.0.2/32
        [Peer]
        PublicKey = ${{ env.WG_PEER_PUBLIC_KEY }}
        Endpoint = ${{ env.WG_ENDPOINT }}
        AllowedIPs = 10.0.0.1/32, 10.204.201.0/24
        PersistentKeepalive = 25
        EOF
        sudo wg-quick up wg0
        ping -c 2 ${{ env.K3S_CLUSTER_IP }}

        # Setup kubectl
        mkdir -p $HOME/.kube
        echo "${{ secrets.K3S_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
        sed -i 's/127.0.0.1/${{ env.K3S_CLUSTER_IP }}/g' $HOME/.kube/config

        # Verify Kubernetes connectivity
        if kubectl get nodes --timeout=10s; then
          echo "‚úÖ Kubernetes connectivity verified"
        else
          echo "‚ùå Cannot connect to Kubernetes cluster"
          exit 1
        fi

        # Deploy test stack using Kubernetes with Docker-built images
        # Note: Images need to be pushed to registry accessible from K3s cluster
        # For now, just verify build succeeds
        echo "‚úÖ Container builds completed successfully"
        echo "‚ö†Ô∏è Full K8s integration test requires image registry setup"

        sudo wg-quick down wg0 || true

    - name: Debug build failure
      if: failure() && steps.k8s_test.outcome == 'failure'
      run: |
        echo "üêû Build failed - Gathering diagnostics..."
        echo ""

        # Re-establish WireGuard for diagnostics
        sudo wg-quick up wg0 || true

        echo "=== WireGuard Status ==="
        sudo wg show

        echo ""
        echo "=== Kubernetes Cluster Status ==="
        kubectl get nodes || echo "Cannot connect to cluster"
        kubectl get pods --all-namespaces || echo "Cannot list pods"

        echo ""
        echo "=== Recent Events ==="
        kubectl get events --sort-by='.lastTimestamp' | tail -20 || echo "Cannot get events"

        sudo wg-quick down wg0 || true

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Run Safety check
      run: |
        pip install -r requirements/base.txt || true
        safety check || true
      continue-on-error: true

    - name: Run Bandit
      run: bandit -r src/ -f json -o bandit-report.json
      continue-on-error: true

    - name: Container Security Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: python:3.11-slim
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.run_id }}
        path: |
          bandit-report.json
          trivy-results.sarif
        retention-days: 30

  deploy:
    name: Deploy to Production
    needs: [test, lint, container-build, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Setup WireGuard tunnel to K3s cluster
      id: wg_setup
      run: |
        echo "üîê Setting up WireGuard tunnel for deployment..."
        START_TIME=$(date +%s)

        sudo apt-get install -y wireguard

        cat <<EOF | sudo tee /etc/wireguard/wg0.conf
        [Interface]
        PrivateKey = ${{ env.WG_PRIVATE_KEY }}
        Address = 10.0.0.2/32
        DNS = 10.204.201.1

        [Peer]
        PublicKey = ${{ env.WG_PEER_PUBLIC_KEY }}
        Endpoint = ${{ env.WG_ENDPOINT }}
        AllowedIPs = 10.0.0.1/32, 10.204.201.0/24
        PersistentKeepalive = 25
        EOF

        sudo wg-quick up wg0
        ping -c 3 ${{ env.K3S_CLUSTER_IP }}

        END_TIME=$(date +%s)
        SETUP_TIME=$((END_TIME - START_TIME))
        echo "‚úÖ WireGuard tunnel established in ${SETUP_TIME}s"

    - name: Verify WireGuard tunnel health
      id: wg_health
      run: |
        echo "üîç Verifying WireGuard tunnel health before deployment..."

        # Check handshake
        HANDSHAKE=$(sudo wg show wg0 | grep -oP '(?<=latest handshake: )[^,]+')
        if [ -n "$HANDSHAKE" ]; then
          echo "‚úÖ Handshake verified: $HANDSHAKE"
        else
          echo "‚ùå No handshake detected!"
          exit 1
        fi

        # Check latency
        LATENCY=$(ping -c 5 -i 0.5 ${{ env.K3S_CLUSTER_IP }} | tail -1 | grep -oP '(?<=mdev = )[\d.]+')
        echo "‚úÖ Latency: ${LATENCY}ms"

        # Verify Kubernetes connectivity
        if ! ping -c 3 ${{ env.K3S_CLUSTER_IP }}; then
          echo "‚ùå Cannot reach cluster"
          exit 1
        fi

        echo "‚úÖ WireGuard tunnel is healthy"

    - name: Configure kubectl for deployment
      run: |
        echo "‚öôÔ∏è Configuring kubectl..."

        mkdir -p $HOME/.kube
        echo "${{ secrets.K3S_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
        sed -i 's/127.0.0.1/${{ env.K3S_CLUSTER_IP }}/g' $HOME/.kube/config
        chmod 600 $HOME/.kube/config

        kubectl cluster-info

    - name: Deploy to K3s Cluster
      run: |
        echo "üöÄ Deploying to K3s cluster..."

        # Apply production manifests
        # kubectl apply -f k8s/production/

        echo "‚úÖ Deployment to K3s completed!"
        echo "This is where you would deploy to production manifests"

    - name: Verify deployment health
      if: success()
      run: |
        echo "üîç Verifying deployment health..."

        # Check rollout status
        # kubectl rollout status deployment/app -n production

        # Check pod health
        # kubectl get pods -n production

        echo "‚úÖ Deployment verification completed"

    - name: Teardown WireGuard tunnel
      if: always()
      run: |
        sudo wg-quick down wg0 || true
        echo "‚úÖ WireGuard tunnel stopped"

  wireguard-report:
    name: WireGuard Metrics Report
    needs: [test, container-build, deploy]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'workflow_dispatch'

    steps:
    - uses: actions/checkout@v4

    - name: Download all diagnostic reports
      uses: actions/download-artifact@v4
      with:
        path: reports/

    - name: Generate comprehensive report
      run: |
        echo "üìä Generating comprehensive WireGuard metrics report..."

        REPORT_FILE=wireguard-metrics-report.md
        echo "# WireGuard Metrics Report" > $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $REPORT_FILE
        echo "**Workflow Run:** ${{ github.run_number }}" >> $REPORT_FILE
        echo "**Repository:** ${{ github.repository }}" >> $REPORT_FILE
        echo "**Branch:** ${{ github.ref_name }}" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        echo "## Executive Summary" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Aggregate metrics from all reports
        if [ -d "reports" ]; then
          echo "Analyzing diagnostic reports..." >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # List all reports
          echo "### Available Reports" >> $REPORT_FILE
          ls -1 reports/ >> $REPORT_FILE
          echo "" >> $REPORT_FILE
        fi

        echo "## Tunnel Status Summary" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Check if jobs passed/failed
        echo "- **Test Job:** ${{ needs.test.result }}" >> $REPORT_FILE
        echo "- **Container Build Job:** ${{ needs.container-build.result }}" >> $REPORT_FILE
        echo "- **Deploy Job:** ${{ needs.deploy.result }}" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        echo "## Performance Metrics" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Extract performance metrics from reports
        find reports/ -name "*.md" -exec grep -h "Latency\|Handshake\|Transfer" {} \; >> $REPORT_FILE || true

        echo "" >> $REPORT_FILE
        echo "## Recommendations" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "Based on the diagnostic data collected:" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "1. **Tunnel Establishment:** Monitor setup time trends" >> $REPORT_FILE
        echo "2. **Latency:** Investigate values exceeding 100ms" >> $REPORT_FILE
        echo "3. **Handshake Health:** Verify regular handshakes (every 2-3 minutes)" >> $REPORT_FILE
        echo "4. **Transfer Volume:** Monitor for unexpected traffic patterns" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        echo "## Historical Trends" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "*Historical data collection and trend analysis coming soon*" >> $REPORT_FILE

        cat $REPORT_FILE

    - name: Upload comprehensive report
      uses: actions/upload-artifact@v4
      with:
        name: wireguard-comprehensive-report
        path: wireguard-metrics-report.md
        retention-days: 30

    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('wireguard-metrics-report.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üìä WireGuard Metrics Report\n\n${report}`
          });
