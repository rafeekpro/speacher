  setup-wireguard:
    name: Setup WireGuard
    runs-on: ubuntu-latest
    env:
      SERVER_WG_IP: 10.204.201.1
    outputs:
      tunnel_ready: ${{ steps.verify-tunnel.outputs.success }}

    steps:
      - name: Install WireGuard
        run: |
          echo "ğŸ“¦ Installing WireGuard..."
          sudo apt-get update
          sudo apt-get install -y wireguard curl

      - name: Setup and start WireGuard
        run: |
          echo "ğŸ”§ Configuring and starting WireGuard tunnel..."
          sudo tee /etc/wireguard/wg0.conf <<EOF
          [Interface]
          PrivateKey = ${{ secrets.WG_PRIVATE_KEY }}
          Address = 10.204.201.8/32
          DNS = 1.1.1.1

          [Peer]
          PublicKey = ${{ secrets.WG_PEER_PUBLIC_KEY }}
          Endpoint = ${{ secrets.SERVER_ENDPOINT || '10.0.0.5:51820' }}
          AllowedIPs = 10.204.201.0/24, 10.0.0.0/8
          PersistentKeepalive = 25
          EOF

          echo "Starting WireGuard interface..."
          sudo wg-quick up wg0

      - name: Show WireGuard status
        run: |
          echo "ğŸ“Š WireGuard Status:"
          sudo wg show wg0

      - name: Verify WireGuard peer added
        id: verify-peer-added
        run: |
          echo "ğŸ” Verifying GitHub Actions peer added to server..."
          sleep 5
          sudo wg show wg0 | grep "peer: ${{ secrets.WG_PEER_PUBLIC_KEY }}" || echo "âŒ Peer not found in server config"
          if sudo wg show wg0 | grep -q "peer: ${{ secrets.WG_PEER_PUBLIC_KEY }}"; then
            echo "âœ… GitHub Actions peer successfully added to server"
          else
            echo "âŒ Failed to add peer - check server config manually"
          fi

      - name: Verify WireGuard handshake
        id: verify-handshake
        run: |
          echo "â³ Waiting for WireGuard handshake..."
          HANDSHAKE=""
          for i in {1..10}; do
            HANDSHAKE=$(sudo wg show wg0 2>/dev/null | grep "latest handshake" || echo "")
            if [ -n "$HANDSHAKE" ]; then
              echo "âœ… Handshake successful: $HANDSHAKE"
              break
            fi
            echo "Waiting... ($i/10)"
            sleep 3
          done

          if [ -z "$HANDSHAKE" ]; then
            echo "âŒ No handshake after 30 seconds"
            echo "Diabling status:"
            sudo wg show wg0
            echo "ğŸ“‹ Serwer WireGuard:"
            sudo wg show wg0
            echo ""
            echo "WyglÄ…da: Port powinien byÄ‡ 51820, a jest 54718"
            echo "Konfiguracja:"
            sudo cat /etc/wireguard/wg0.conf | head -20
            echo ""
            echo "Czy na pewno port serwera to 51820? (t/n)"
            exit 1
